from django.core.management.base import BaseCommand
from django.contrib.auth.models import User
from prompts.models import UserPrompt


class Command(BaseCommand):
    help = 'ä¸ºæ‰€æœ‰ç”¨æˆ·åˆå§‹åŒ–é»˜è®¤çš„ç¨‹åºè°ƒç”¨æç¤ºè¯'

    def add_arguments(self, parser):
        parser.add_argument(
            '--user-id',
            type=int,
            help='ä¸ºæŒ‡å®šç”¨æˆ·IDåˆå§‹åŒ–æç¤ºè¯ï¼Œä¸æŒ‡å®šåˆ™ä¸ºæ‰€æœ‰ç”¨æˆ·åˆå§‹åŒ–'
        )
        parser.add_argument(
            '--force',
            action='store_true',
            help='å¼ºåˆ¶è¦†ç›–å·²å­˜åœ¨çš„æç¤ºè¯'
        )

    def handle(self, *args, **options):
        user_id = options.get('user_id')
        force = options.get('force', False)

        if user_id:
            try:
                users = [User.objects.get(id=user_id)]
                self.stdout.write(f"ä¸ºç”¨æˆ· {users[0].username} åˆå§‹åŒ–æç¤ºè¯...")
            except User.DoesNotExist:
                self.stdout.write(
                    self.style.ERROR(f'ç”¨æˆ·ID {user_id} ä¸å­˜åœ¨')
                )
                return
        else:
            users = User.objects.all()
            self.stdout.write(f"ä¸ºæ‰€æœ‰ {users.count()} ä¸ªç”¨æˆ·åˆå§‹åŒ–æç¤ºè¯...")

        # é»˜è®¤æç¤ºè¯å®šä¹‰
        default_prompts = {
            'document_structure': {
                'name': 'æ–‡æ¡£ç»“æ„åˆ†æ',
                'description': 'ç”¨äºåˆ†æéœ€æ±‚æ–‡æ¡£ç»“æ„ï¼Œè¯†åˆ«åŠŸèƒ½æ¨¡å—è¾¹ç•Œçš„æç¤ºè¯',
                'content': """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„éœ€æ±‚åˆ†æå¸ˆï¼Œè¯·ä»”ç»†åˆ†æä»¥ä¸‹éœ€æ±‚æ–‡æ¡£ï¼Œè¯†åˆ«å‡ºæ‰€æœ‰çš„ä¸»è¦åŠŸèƒ½æ¨¡å—ã€‚

ã€åˆ†ææ ‡å‡†ã€‘
1. ä»¥ä¸€çº§æ ‡é¢˜ï¼ˆ#ï¼‰æˆ–äºŒçº§æ ‡é¢˜ï¼ˆ##ï¼‰ä½œä¸ºæ¨¡å—åˆ’åˆ†çš„ä¸»è¦ä¾æ®
2. æ¯ä¸ªæ¨¡å—åº”è¯¥åŒ…å«å®Œæ•´çš„åŠŸèƒ½æè¿°ï¼Œä¸è¦é—æ¼ä»»ä½•éƒ¨åˆ†
3. æ¨¡å—åº”è¯¥ç›¸å¯¹ç‹¬ç«‹ï¼Œæœ‰æ˜ç¡®çš„åŠŸèƒ½è¾¹ç•Œ
4. ç¡®ä¿æ‰€æœ‰å†…å®¹éƒ½è¢«åˆ†é…åˆ°æŸä¸ªæ¨¡å—ä¸­ï¼Œä¸è¦é—æ¼

ã€æ–‡æ¡£å†…å®¹ã€‘
{content}

ã€è¾“å‡ºè¦æ±‚ã€‘
è¯·ä»”ç»†é˜…è¯»æ•´ä¸ªæ–‡æ¡£ï¼Œè¯†åˆ«å‡ºæ‰€æœ‰çš„åŠŸèƒ½æ¨¡å—ã€‚å¯¹äºæ¯ä¸ªæ¨¡å—ï¼š
- å‡†ç¡®è¯†åˆ«æ¨¡å—çš„å¼€å§‹å’Œç»“æŸä½ç½®
- ç¡®ä¿æ¨¡å—å†…å®¹å®Œæ•´ï¼Œä¸è¦æˆªæ–­
- ç»™å‡ºåˆç†çš„ç½®ä¿¡åº¦è¯„åˆ†

ã€è¾“å‡ºæ ¼å¼ã€‘
è¯·ä»¥JSONæ ¼å¼è¾“å‡ºæ¨¡å—ç»“æ„ï¼š
```json
[
  {{
    "title": "æ¨¡å—åç§°ï¼ˆä¸æ–‡æ¡£ä¸­çš„æ ‡é¢˜ä¿æŒä¸€è‡´ï¼‰",
    "description": "æ¨¡å—åŠŸèƒ½çš„ç®€è¦æè¿°",
    "start_marker": "æ¨¡å—å¼€å§‹çš„ç¡®åˆ‡æ–‡æœ¬ï¼ˆåŒ…å«æ ‡é¢˜ï¼‰",
    "end_marker": "ä¸‹ä¸€ä¸ªæ¨¡å—å¼€å§‹çš„æ–‡æœ¬ï¼ˆå¦‚æœæ˜¯æœ€åä¸€ä¸ªæ¨¡å—åˆ™ä¸ºç©ºï¼‰",
    "confidence": 0.95,
    "estimated_complexity": "medium"
  }}
]
```

é‡è¦ï¼šè¯·ç¡®ä¿è¯†åˆ«å‡ºæ–‡æ¡£ä¸­çš„æ‰€æœ‰ä¸»è¦æ¨¡å—ï¼Œä¸è¦é—æ¼ä»»ä½•éƒ¨åˆ†ï¼"""
            },
            'direct_analysis': {
                'name': 'ç›´æ¥åˆ†æ',
                'description': 'ç”¨äºç›´æ¥åˆ†ææ•´ä¸ªéœ€æ±‚æ–‡æ¡£çš„æç¤ºè¯',
                'content': """ä½ æ˜¯ä¸€ä½èµ„æ·±çš„éœ€æ±‚åˆ†æå¸ˆï¼Œæ­£åœ¨å¯¹éœ€æ±‚æ–‡æ¡£è¿›è¡Œä¸“ä¸šè¯„å®¡ã€‚è¯·å¯¹ä»¥ä¸‹æ–‡æ¡£è¿›è¡Œå…¨é¢åˆ†æï¼š

ã€æ–‡æ¡£å†…å®¹ã€‘
{content}

ã€è¯„å®¡è¦æ±‚ã€‘
è¯·ä»ä»¥ä¸‹ç»´åº¦è¿›è¡Œä¸“ä¸šè¯„å®¡ï¼š

1. ğŸ“‹ **è§„èŒƒæ€§æ£€æŸ¥** (0-100åˆ†)
   - æ–‡æ¡£ç»“æ„æ˜¯å¦æ¸…æ™°
   - æ ¼å¼æ˜¯å¦è§„èŒƒ
   - å¿…è¦ä¿¡æ¯æ˜¯å¦å®Œæ•´

2. ğŸ” **æ¸…æ™°åº¦è¯„ä¼°** (0-100åˆ†)
   - éœ€æ±‚æè¿°æ˜¯å¦æ¸…æ™°
   - æ˜¯å¦å­˜åœ¨æ­§ä¹‰è¡¨è¿°
   - æœ¯è¯­ä½¿ç”¨æ˜¯å¦ä¸€è‡´

3. âœ… **å®Œæ•´æ€§éªŒè¯** (0-100åˆ†)
   - åŠŸèƒ½éœ€æ±‚æ˜¯å¦å®Œæ•´
   - éåŠŸèƒ½éœ€æ±‚æ˜¯å¦è€ƒè™‘
   - å¼‚å¸¸åœºæ™¯æ˜¯å¦è¦†ç›–

4. ğŸ”— **ä¸€è‡´æ€§æ£€æŸ¥** (0-100åˆ†)
   - å†…éƒ¨é€»è¾‘æ˜¯å¦ä¸€è‡´
   - ä¸šåŠ¡è§„åˆ™æ˜¯å¦å†²çª
   - æ•°æ®å®šä¹‰æ˜¯å¦ç»Ÿä¸€

ã€è¾“å‡ºæ ¼å¼ã€‘
è¯·ä»¥JSONæ ¼å¼è¾“å‡ºè¯„å®¡ç»“æœï¼š
```json
{{
  "overall_rating": "good",
  "completion_score": 85,
  "clarity_score": 78,
  "consistency_score": 82,
  "completeness_score": 88,
  "summary": "æ–‡æ¡£æ•´ä½“è´¨é‡è‰¯å¥½ï¼Œç»“æ„æ¸…æ™°...",
  "recommendations": "å»ºè®®å®Œå–„å¼‚å¸¸å¤„ç†åœºæ™¯...",
  "issues": [
    {{
      "title": "é—®é¢˜æ ‡é¢˜",
      "description": "é—®é¢˜æè¿°",
      "priority": "high",
      "category": "completeness",
      "location": "ç¬¬2ç« ç”¨æˆ·ç®¡ç†æ¨¡å—",
      "suggestion": "æ”¹è¿›å»ºè®®"
    }}
  ]
}}
```"""
            },
            'global_analysis': {
                'name': 'å…¨å±€åˆ†æ',
                'description': 'ç”¨äºåˆ†æéœ€æ±‚æ–‡æ¡£å…¨å±€ç»“æ„å’Œä¸Šä¸‹æ–‡çš„æç¤ºè¯',
                'content': """ä½ æ˜¯ä¸€ä½èµ„æ·±çš„éœ€æ±‚åˆ†æå¸ˆï¼Œæ­£åœ¨è¿›è¡Œéœ€æ±‚è¯„å®¡ã€‚è¯·å¯¹ä»¥ä¸‹éœ€æ±‚æ–‡æ¡£è¿›è¡Œå…¨å±€ç»“æ„åˆ†æï¼š

ã€æ–‡æ¡£ä¿¡æ¯ã€‘
æ ‡é¢˜: {title}
æè¿°: {description}
å†…å®¹: {content}

ã€åˆ†æè¦æ±‚ã€‘
è¯·ä»ä»¥ä¸‹ç»´åº¦è¿›è¡Œå…¨å±€åˆ†æï¼š

1. ğŸ“‹ **æ–‡æ¡£ç»“æ„è§„èŒƒæ€§**
   - æ–‡æ¡£ç»„ç»‡ç»“æ„æ˜¯å¦æ¸…æ™°
   - ç« èŠ‚ç¼–å·æ˜¯å¦è§„èŒƒ
   - æ ‡é¢˜å±‚çº§æ˜¯å¦åˆç†

2. ğŸ¯ **ä¸šåŠ¡å®Œæ•´æ€§**
   - ä¸šåŠ¡æµç¨‹æ˜¯å¦å®Œæ•´
   - æ ¸å¿ƒåŠŸèƒ½æ˜¯å¦é—æ¼
   - ä¸šåŠ¡è¾¹ç•Œæ˜¯å¦æ¸…æ™°

3. ğŸ”— **é€»è¾‘ä¸€è‡´æ€§**
   - æ•´ä½“é€»è¾‘æ˜¯å¦è‡ªæ´½
   - ä¸šåŠ¡è§„åˆ™æ˜¯å¦ä¸€è‡´
   - æ•°æ®æµæ˜¯å¦åˆç†

4. ğŸ“Š **è´¨é‡è¯„ä¼°**
   - éœ€æ±‚æè¿°çš„æ¸…æ™°åº¦
   - å¯å®ç°æ€§è¯„ä¼°
   - é£é™©ç‚¹è¯†åˆ«

ã€è¾“å‡ºæ ¼å¼ã€‘
è¯·ä»¥JSONæ ¼å¼è¾“å‡ºåˆ†æç»“æœï¼š
```json
{{
  "structure_score": 85,
  "completeness_score": 78,
  "consistency_score": 90,
  "clarity_score": 82,
  "overall_score": 84,
  "business_flows": ["ç”¨æˆ·æ³¨å†Œæµç¨‹", "è®¢å•å¤„ç†æµç¨‹"],
  "data_entities": ["ç”¨æˆ·", "å•†å“", "è®¢å•"],
  "global_rules": ["æ‰€æœ‰æ“ä½œéœ€è¦ç™»å½•", "æ”¯ä»˜å¿…é¡»éªŒè¯"],
  "missing_aspects": ["å¼‚å¸¸å¤„ç†", "æ€§èƒ½è¦æ±‚"],
  "risk_points": ["æ”¯ä»˜å®‰å…¨", "æ•°æ®ä¸€è‡´æ€§"],
  "strengths": ["ä¸šåŠ¡æµç¨‹æ¸…æ™°", "åŠŸèƒ½åˆ’åˆ†åˆç†"],
  "weaknesses": ["ç¼ºå°‘éåŠŸèƒ½éœ€æ±‚", "å¼‚å¸¸åœºæ™¯ä¸å®Œæ•´"]
}}
```"""
            },
            'module_analysis': {
                'name': 'æ¨¡å—åˆ†æ',
                'description': 'ç”¨äºåˆ†æå•ä¸ªéœ€æ±‚æ¨¡å—çš„æç¤ºè¯',
                'content': """ä½ æ­£åœ¨è¯„å®¡éœ€æ±‚æ–‡æ¡£çš„ä¸€ä¸ªåŠŸèƒ½æ¨¡å—ã€‚è¯·è¿›è¡Œä¸“ä¸šçš„éœ€æ±‚è¯„å®¡åˆ†æï¼š

ã€æ¨¡å—ä¿¡æ¯ã€‘
æ¨¡å—åç§°: {module_title}
æ¨¡å—å†…å®¹: {module_content}

ã€å…¨å±€ä¸Šä¸‹æ–‡ã€‘
ä¸šåŠ¡æµç¨‹: {business_flows}
æ•°æ®å®ä½“: {data_entities}
å…¨å±€è§„åˆ™: {global_rules}

ã€è¯„å®¡ç»´åº¦ã€‘
è¯·ä»ä»¥ä¸‹ç»´åº¦è¿›è¡Œè¯¦ç»†åˆ†æï¼š

1. ğŸ“‹ **è§„èŒƒæ€§æ£€æŸ¥**
   - éœ€æ±‚æè¿°æ˜¯å¦å®Œæ•´
   - æ ¼å¼æ˜¯å¦ç¬¦åˆæ ‡å‡†
   - å¿…è¦ä¿¡æ¯æ˜¯å¦ç¼ºå¤±

2. ğŸ” **æ¸…æ™°åº¦è¯„ä¼°**
   - è¡¨è¿°æ˜¯å¦æ¨¡ç³Šä¸æ¸…
   - æ˜¯å¦å­˜åœ¨æ­§ä¹‰
   - æœ¯è¯­ä½¿ç”¨æ˜¯å¦ä¸€è‡´

3. âœ… **å®Œæ•´æ€§éªŒè¯**
   - åŠŸèƒ½éœ€æ±‚æ˜¯å¦å®Œæ•´
   - å¼‚å¸¸åœºæ™¯æ˜¯å¦è€ƒè™‘
   - è¾¹ç•Œæ¡ä»¶æ˜¯å¦æ˜ç¡®

4. ğŸ”— **ä¸€è‡´æ€§æ£€æŸ¥**
   - ä¸å…¨å±€è§„åˆ™æ˜¯å¦ä¸€è‡´
   - ä¸å…¶ä»–æ¨¡å—æ˜¯å¦å†²çª
   - æ•°æ®å®šä¹‰æ˜¯å¦ç»Ÿä¸€

5. âš ï¸ **å¯è¡Œæ€§è¯„ä¼°**
   - æŠ€æœ¯å®ç°éš¾åº¦
   - ä¸šåŠ¡åˆç†æ€§
   - èµ„æºéœ€æ±‚è¯„ä¼°

ã€è¾“å‡ºæ ¼å¼ã€‘
è¯·ä»¥JSONæ ¼å¼è¾“å‡ºåˆ†æç»“æœï¼š
```json
{{
  "module_id": "{module_id}",
  "module_name": "{module_title}",
  "specification_score": 85,
  "clarity_score": 78,
  "completeness_score": 90,
  "consistency_score": 82,
  "feasibility_score": 88,
  "overall_score": 84,
  "issues": [
    {{
      "type": "clarity",
      "priority": "high",
      "title": "ç”¨æˆ·æƒé™å®šä¹‰æ¨¡ç³Š",
      "description": "æƒé™ç­‰çº§çš„å…·ä½“å®šä¹‰ä¸æ¸…æ™°",
      "location": "æƒé™ç®¡ç†éƒ¨åˆ†",
      "suggestion": "å»ºè®®æ˜ç¡®å®šä¹‰å„æƒé™ç­‰çº§çš„å…·ä½“æƒé™èŒƒå›´"
    }}
  ],
  "strengths": ["åŠŸèƒ½æè¿°æ¸…æ™°", "ä¸šåŠ¡æµç¨‹åˆç†"],
  "weaknesses": ["ç¼ºå°‘å¼‚å¸¸å¤„ç†", "è¾¹ç•Œæ¡ä»¶ä¸æ˜ç¡®"],
  "recommendations": ["è¡¥å……å¼‚å¸¸åœºæ™¯", "æ˜ç¡®æ•°æ®æ ¼å¼"]
}}
```"""
            },
            'consistency_analysis': {
                'name': 'ä¸€è‡´æ€§åˆ†æ',
                'description': 'ç”¨äºåˆ†æéœ€æ±‚æ–‡æ¡£è·¨æ¨¡å—ä¸€è‡´æ€§çš„æç¤ºè¯',
                'content': """ä½ æ­£åœ¨è¿›è¡Œéœ€æ±‚æ–‡æ¡£çš„è·¨æ¨¡å—ä¸€è‡´æ€§æ£€æŸ¥ã€‚è¯·åˆ†æå„æ¨¡å—é—´çš„ä¸€è‡´æ€§é—®é¢˜ï¼š

ã€å…¨å±€ä¸Šä¸‹æ–‡ã€‘
{global_context}

ã€å„æ¨¡å—åˆ†æç»“æœã€‘
{module_analyses}

ã€ä¸€è‡´æ€§æ£€æŸ¥è¦æ±‚ã€‘
è¯·é‡ç‚¹æ£€æŸ¥ä»¥ä¸‹æ–¹é¢ï¼š

1. ğŸ”— **æ¥å£ä¸€è‡´æ€§**
   - æ¨¡å—é—´æ¥å£å®šä¹‰æ˜¯å¦ä¸€è‡´
   - æ•°æ®ä¼ é€’æ ¼å¼æ˜¯å¦ç»Ÿä¸€
   - è°ƒç”¨å…³ç³»æ˜¯å¦æ¸…æ™°

2. ğŸ“Š **æ•°æ®ä¸€è‡´æ€§**
   - æ•°æ®å®ä½“å®šä¹‰æ˜¯å¦ç»Ÿä¸€
   - çŠ¶æ€å®šä¹‰æ˜¯å¦ä¸€è‡´
   - æ•°æ®æµè½¬æ˜¯å¦åˆç†

3. ğŸ“‹ **ä¸šåŠ¡è§„åˆ™ä¸€è‡´æ€§**
   - ä¸šåŠ¡è§„åˆ™åœ¨å„æ¨¡å—ä¸­æ˜¯å¦ä¸€è‡´
   - æƒé™æ§åˆ¶æ˜¯å¦ç»Ÿä¸€
   - å¼‚å¸¸å¤„ç†æ˜¯å¦ä¸€è‡´

4. ğŸ”„ **æµç¨‹å®Œæ•´æ€§**
   - ä¸šåŠ¡æµç¨‹æ˜¯å¦é—­ç¯
   - æ˜¯å¦å­˜åœ¨æµç¨‹æ–­ç‚¹
   - å¼‚å¸¸æµç¨‹æ˜¯å¦å®Œæ•´

ã€è¾“å‡ºæ ¼å¼ã€‘
è¯·ä»¥JSONæ ¼å¼è¾“å‡ºåˆ†æç»“æœï¼š
```json
{{
  "consistency_score": 85,
  "interface_consistency": 78,
  "data_consistency": 90,
  "business_rule_consistency": 82,
  "process_completeness": 88,
  "cross_module_issues": [
    {{
      "type": "data_inconsistency",
      "priority": "high",
      "title": "ç”¨æˆ·çŠ¶æ€å®šä¹‰ä¸ä¸€è‡´",
      "description": "ç”¨æˆ·ç®¡ç†æ¨¡å—å’Œè®¢å•æ¨¡å—å¯¹ç”¨æˆ·çŠ¶æ€å®šä¹‰ä¸åŒ",
      "affected_modules": ["ç”¨æˆ·ç®¡ç†", "è®¢å•ç®¡ç†"],
      "suggestion": "ç»Ÿä¸€ç”¨æˆ·çŠ¶æ€å®šä¹‰ï¼Œå»ºç«‹æ•°æ®å­—å…¸"
    }}
  ],
  "missing_connections": ["æ”¯ä»˜æ¨¡å—ä¸åº“å­˜æ¨¡å—ç¼ºå°‘è¿æ¥"],
  "redundant_functions": ["ç”¨æˆ·éªŒè¯åŠŸèƒ½åœ¨å¤šä¸ªæ¨¡å—é‡å¤"],
  "recommendations": ["å»ºç«‹ç»Ÿä¸€çš„æ•°æ®å­—å…¸", "æ˜ç¡®æ¨¡å—é—´æ¥å£è§„èŒƒ"]
}}
```"""
            }
        }

        created_count = 0
        updated_count = 0
        skipped_count = 0

        for user in users:
            for prompt_type, prompt_data in default_prompts.items():
                existing_prompt = UserPrompt.objects.filter(
                    user=user,
                    prompt_type=prompt_type
                ).first()

                if existing_prompt:
                    if force:
                        existing_prompt.name = prompt_data['name']
                        existing_prompt.description = prompt_data['description']
                        existing_prompt.content = prompt_data['content']
                        existing_prompt.save()
                        updated_count += 1
                        self.stdout.write(f"  æ›´æ–°: {user.username} - {prompt_data['name']}")
                    else:
                        skipped_count += 1
                        self.stdout.write(f"  è·³è¿‡: {user.username} - {prompt_data['name']} (å·²å­˜åœ¨)")
                else:
                    UserPrompt.objects.create(
                        user=user,
                        name=prompt_data['name'],
                        description=prompt_data['description'],
                        content=prompt_data['content'],
                        prompt_type=prompt_type,
                        is_default=False,  # ç¨‹åºè°ƒç”¨ç±»å‹ä¸èƒ½è®¾ä¸ºé»˜è®¤
                        is_active=True
                    )
                    created_count += 1
                    self.stdout.write(f"  åˆ›å»º: {user.username} - {prompt_data['name']}")

        self.stdout.write(
            self.style.SUCCESS(
                f'\nåˆå§‹åŒ–å®Œæˆï¼åˆ›å»º: {created_count}, æ›´æ–°: {updated_count}, è·³è¿‡: {skipped_count}'
            )
        )
