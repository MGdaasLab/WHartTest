from rest_framework import status, permissions
from rest_framework.decorators import action
from rest_framework.response import Response
from django_filters.rest_framework import DjangoFilterBackend
from rest_framework import filters

from wharttest_django.viewsets import BaseModelViewSet
from wharttest_django.permissions import HasModelPermission
from .models import UserPrompt
from .serializers import (
    UserPromptSerializer,
    UserPromptListSerializer
)


class UserPromptViewSet(BaseModelViewSet):
    """
    ç”¨æˆ·æç¤ºè¯ç®¡ç†è§†å›¾é›†
    æä¾›ç”¨æˆ·çº§åˆ«çš„æç¤ºè¯CRUDæ“ä½œ
    """
    serializer_class = UserPromptSerializer
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['is_default', 'is_active', 'prompt_type']
    search_fields = ['name', 'description']
    ordering_fields = ['created_at', 'updated_at', 'name']
    ordering = ['-updated_at']

    def get_permissions(self):
        """è¿”å›žæ­¤è§†å›¾æ‰€éœ€æƒé™çš„å®žä¾‹åˆ—è¡¨"""
        return [
            HasModelPermission(),
        ]

    def get_queryset(self):
        """åªè¿”å›žå½“å‰ç”¨æˆ·çš„æç¤ºè¯"""
        return UserPrompt.objects.filter(user=self.request.user)

    def get_serializer_class(self):
        """æ ¹æ®æ“ä½œç±»åž‹è¿”å›žä¸åŒçš„åºåˆ—åŒ–å™¨"""
        if self.action == 'list':
            return UserPromptListSerializer
        return UserPromptSerializer

    def perform_create(self, serializer):
        """åˆ›å»ºæ—¶è‡ªåŠ¨è®¾ç½®ç”¨æˆ·"""
        serializer.save(user=self.request.user)

    @action(detail=False, methods=['get'])
    def default(self, request):
        """èŽ·å–ç”¨æˆ·çš„é»˜è®¤æç¤ºè¯"""
        default_prompt = UserPrompt.get_user_default_prompt(request.user)

        if default_prompt:
            serializer = self.get_serializer(default_prompt)
            return Response(serializer.data)
        else:
            return Response({
                "status": "success",
                "code": status.HTTP_200_OK,
                "message": "ç”¨æˆ·æš‚æ— é»˜è®¤æç¤ºè¯",
                "data": None,
                "errors": {}
            })

    @action(detail=False, methods=['get'])
    def by_type(self, request):
        """æ ¹æ®ç±»åž‹èŽ·å–æç¤ºè¯"""
        prompt_type = request.query_params.get('type')
        if not prompt_type:
            return Response({
                "status": "error",
                "code": status.HTTP_400_BAD_REQUEST,
                "message": "ç¼ºå°‘typeå‚æ•°",
                "data": None,
                "errors": {"type": ["æ­¤å­—æ®µæ˜¯å¿…éœ€çš„"]}
            }, status=status.HTTP_400_BAD_REQUEST)

        prompt = UserPrompt.get_user_prompt_by_type(request.user, prompt_type)
        if prompt:
            serializer = self.get_serializer(prompt)
            return Response(serializer.data)
        else:
            return Response({
                "status": "success",
                "code": status.HTTP_200_OK,
                "message": f"ç”¨æˆ·æš‚æ— {prompt_type}ç±»åž‹çš„æç¤ºè¯",
                "data": None,
                "errors": {}
            })

    @action(detail=False, methods=['get'])
    def types(self, request):
        """èŽ·å–æ‰€æœ‰æç¤ºè¯ç±»åž‹"""
        types = [
            {
                'value': choice[0],
                'label': choice[1],
                'is_program_call': choice[0] in UserPrompt.PROGRAM_CALL_TYPES
            }
            for choice in UserPrompt.PROMPT_TYPE_CHOICES
        ]
        return Response({
            "status": "success",
            "code": status.HTTP_200_OK,
            "message": "èŽ·å–æˆåŠŸ",
            "data": types,
            "errors": {}
        })

    @action(detail=True, methods=['post'])
    def set_default(self, request, pk=None):
        """è®¾ç½®æŒ‡å®šæç¤ºè¯ä¸ºé»˜è®¤æç¤ºè¯"""
        prompt = self.get_object()

        # æ£€æŸ¥æç¤ºè¯æ˜¯å¦å±žäºŽå½“å‰ç”¨æˆ·ä¸”å¤„äºŽæ¿€æ´»çŠ¶æ€
        if not prompt.is_active:
            return Response({
                "status": "error",
                "code": status.HTTP_400_BAD_REQUEST,
                "message": "æ— æ³•è®¾ç½®æœªæ¿€æ´»çš„æç¤ºè¯ä¸ºé»˜è®¤",
                "data": {},
                "errors": {"prompt": ["æç¤ºè¯æœªæ¿€æ´»"]}
            }, status=status.HTTP_400_BAD_REQUEST)

        # æ£€æŸ¥æ˜¯å¦ä¸ºç¨‹åºè°ƒç”¨ç±»åž‹ï¼ˆç¨‹åºè°ƒç”¨ç±»åž‹ä¸å…è®¸è®¾ä¸ºé»˜è®¤ï¼‰
        if prompt.prompt_type in UserPrompt.PROGRAM_CALL_TYPES:
            return Response({
                "status": "error",
                "code": status.HTTP_400_BAD_REQUEST,
                "message": "ç¨‹åºè°ƒç”¨ç±»åž‹çš„æç¤ºè¯ä¸èƒ½è®¾ä¸ºé»˜è®¤",
                "data": {},
                "errors": {"prompt_type": ["ç¨‹åºè°ƒç”¨ç±»åž‹çš„æç¤ºè¯ä¸èƒ½è®¾ä¸ºé»˜è®¤ï¼Œä¼šå½±å“å¯¹è¯åŠŸèƒ½"]}
            }, status=status.HTTP_400_BAD_REQUEST)

        # å–æ¶ˆå…¶ä»–é»˜è®¤æç¤ºè¯
        UserPrompt.objects.filter(
            user=request.user,
            is_default=True
        ).exclude(pk=prompt.pk).update(is_default=False)

        # è®¾ç½®å½“å‰æç¤ºè¯ä¸ºé»˜è®¤
        prompt.is_default = True
        prompt.save()

        serializer = self.get_serializer(prompt)
        return Response({
            "status": "success",
            "code": status.HTTP_200_OK,
            "message": "é»˜è®¤æç¤ºè¯è®¾ç½®æˆåŠŸ",
            "data": serializer.data,
            "errors": {}
        })

    @action(detail=False, methods=['post'])
    def clear_default(self, request):
        """æ¸…é™¤ç”¨æˆ·çš„é»˜è®¤æç¤ºè¯è®¾ç½®"""
        updated_count = UserPrompt.objects.filter(
            user=request.user,
            is_default=True
        ).update(is_default=False)

        return Response({
            "status": "success",
            "code": status.HTTP_200_OK,
            "message": f"å·²æ¸…é™¤é»˜è®¤æç¤ºè¯è®¾ç½®ï¼Œå½±å“{updated_count}æ¡è®°å½•",
            "data": {"updated_count": updated_count},
            "errors": {}
        })

    @action(detail=True, methods=['post'])
    def duplicate(self, request, pk=None):
        """å¤åˆ¶æç¤ºè¯"""
        original_prompt = self.get_object()

        # åˆ›å»ºå‰¯æœ¬
        new_prompt = UserPrompt.objects.create(
            user=request.user,
            name=f"{original_prompt.name} (å‰¯æœ¬)",
            content=original_prompt.content,
            description=f"å¤åˆ¶è‡ª: {original_prompt.description}" if original_prompt.description else "å¤åˆ¶çš„æç¤ºè¯",
            is_default=False,  # å‰¯æœ¬ä¸è®¾ä¸ºé»˜è®¤
            is_active=True
        )

        serializer = self.get_serializer(new_prompt)
        return Response({
            "status": "success",
            "code": status.HTTP_201_CREATED,
            "message": "æç¤ºè¯å¤åˆ¶æˆåŠŸ",
            "data": serializer.data,
            "errors": {}
        }, status=status.HTTP_201_CREATED)

    @action(detail=False, methods=['post'])
    def initialize(self, request):
        """åˆå§‹åŒ–ç”¨æˆ·çš„é»˜è®¤æç¤ºè¯"""
        # é»˜è®¤æç¤ºè¯æ¨¡æ¿
        default_prompts = {
            'general': {
                'name': 'é»˜è®¤å¯¹è¯åŠ©æ‰‹',
                'description': 'é€šç”¨çš„AIå¯¹è¯åŠ©æ‰‹ï¼Œé€‚ç”¨äºŽæ—¥å¸¸äº¤æµå’Œé—®é¢˜è§£ç­”',
                'content': """ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„AIåŠ©æ‰‹ï¼Œå¯ä»¥å¸®åŠ©ç”¨æˆ·è§£ç­”å„ç§é—®é¢˜ã€‚

ã€åŸºæœ¬åŽŸåˆ™ã€‘
1. å‹å¥½ã€ä¸“ä¸šã€å‡†ç¡®åœ°å›žç­”ç”¨æˆ·é—®é¢˜
2. å¯¹ä¸ç¡®å®šçš„å†…å®¹è¯šå®žå‘ŠçŸ¥ï¼Œé¿å…è‡†æµ‹
3. æ ¹æ®ç”¨æˆ·éœ€æ±‚æä¾›æœ‰é’ˆå¯¹æ€§çš„å»ºè®®
4. ä¿æŒå®¢è§‚ä¸­ç«‹çš„æ€åº¦

ã€å›žç­”è¦æ±‚ã€‘
- è¨€ç®€æ„èµ…ï¼Œçªå‡ºè¦ç‚¹
- ç»“æž„æ¸…æ™°ï¼Œä¾¿äºŽç†è§£
- å®žç”¨æ€§å¼ºï¼Œå¯æ“ä½œæ€§é«˜
- åŠæ—¶å…³æ³¨ç”¨æˆ·çš„åŽç»­éœ€æ±‚

è¯·æ ¹æ®ç”¨æˆ·çš„å…·ä½“é—®é¢˜ï¼Œæä¾›ä¸“ä¸šã€æœ‰ç”¨çš„å›žç­”ã€‚"""
            },
            'document_structure': {
                'name': 'æ–‡æ¡£ç»“æž„åˆ†æž',
                'description': 'ç”¨äºŽåˆ†æžéœ€æ±‚æ–‡æ¡£ç»“æž„ï¼Œè¯†åˆ«åŠŸèƒ½æ¨¡å—è¾¹ç•Œçš„æç¤ºè¯',
                'content': """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„éœ€æ±‚åˆ†æžå¸ˆï¼Œè¯·ä»”ç»†åˆ†æžä»¥ä¸‹éœ€æ±‚æ–‡æ¡£ï¼Œè¯†åˆ«å‡ºæ‰€æœ‰çš„ä¸»è¦åŠŸèƒ½æ¨¡å—ã€‚

ã€åˆ†æžæ ‡å‡†ã€‘
1. ä»¥ä¸€çº§æ ‡é¢˜ï¼ˆ#ï¼‰æˆ–äºŒçº§æ ‡é¢˜ï¼ˆ##ï¼‰ä½œä¸ºæ¨¡å—åˆ’åˆ†çš„ä¸»è¦ä¾æ®
2. æ¯ä¸ªæ¨¡å—åº”è¯¥åŒ…å«å®Œæ•´çš„åŠŸèƒ½æè¿°ï¼Œä¸è¦é—æ¼ä»»ä½•éƒ¨åˆ†
3. æ¨¡å—åº”è¯¥ç›¸å¯¹ç‹¬ç«‹ï¼Œæœ‰æ˜Žç¡®çš„åŠŸèƒ½è¾¹ç•Œ
4. ç¡®ä¿æ‰€æœ‰å†…å®¹éƒ½è¢«åˆ†é…åˆ°æŸä¸ªæ¨¡å—ä¸­ï¼Œä¸è¦é—æ¼

ã€æ–‡æ¡£å†…å®¹ã€‘
{content}

ã€è¾“å‡ºè¦æ±‚ã€‘
è¯·ä»”ç»†é˜…è¯»æ•´ä¸ªæ–‡æ¡£ï¼Œè¯†åˆ«å‡ºæ‰€æœ‰çš„åŠŸèƒ½æ¨¡å—ã€‚å¯¹äºŽæ¯ä¸ªæ¨¡å—ï¼š
- å‡†ç¡®è¯†åˆ«æ¨¡å—çš„å¼€å§‹å’Œç»“æŸä½ç½®
- ç¡®ä¿æ¨¡å—å†…å®¹å®Œæ•´ï¼Œä¸è¦æˆªæ–­
- ç»™å‡ºåˆç†çš„ç½®ä¿¡åº¦è¯„åˆ†

ã€è¾“å‡ºæ ¼å¼ã€‘
è¯·ä»¥JSONæ ¼å¼è¾“å‡ºæ¨¡å—ç»“æž„ï¼š
```json
[
  {{
    "title": "æ¨¡å—åç§°ï¼ˆä¸Žæ–‡æ¡£ä¸­çš„æ ‡é¢˜ä¿æŒä¸€è‡´ï¼‰",
    "description": "æ¨¡å—åŠŸèƒ½çš„ç®€è¦æè¿°",
    "start_marker": "æ¨¡å—å¼€å§‹çš„ç¡®åˆ‡æ–‡æœ¬ï¼ˆåŒ…å«æ ‡é¢˜ï¼‰",
    "end_marker": "ä¸‹ä¸€ä¸ªæ¨¡å—å¼€å§‹çš„æ–‡æœ¬ï¼ˆå¦‚æžœæ˜¯æœ€åŽä¸€ä¸ªæ¨¡å—åˆ™ä¸ºç©ºï¼‰",
    "confidence": 0.95,
    "estimated_complexity": "medium"
  }}
]
```

é‡è¦ï¼šè¯·ç¡®ä¿è¯†åˆ«å‡ºæ–‡æ¡£ä¸­çš„æ‰€æœ‰ä¸»è¦æ¨¡å—ï¼Œä¸è¦é—æ¼ä»»ä½•éƒ¨åˆ†ï¼"""
            },
            'direct_analysis': {
                'name': 'ç›´æŽ¥åˆ†æž',
                'description': 'ç”¨äºŽç›´æŽ¥åˆ†æžæ•´ä¸ªéœ€æ±‚æ–‡æ¡£çš„æç¤ºè¯',
                'content': """ä½ æ˜¯ä¸€ä½èµ„æ·±çš„éœ€æ±‚åˆ†æžå¸ˆï¼Œæ­£åœ¨å¯¹éœ€æ±‚æ–‡æ¡£è¿›è¡Œä¸“ä¸šè¯„å®¡ã€‚è¯·å¯¹ä»¥ä¸‹æ–‡æ¡£è¿›è¡Œå…¨é¢åˆ†æžï¼š

ã€æ–‡æ¡£å†…å®¹ã€‘
{content}

ã€è¯„å®¡è¦æ±‚ã€‘
è¯·ä»Žä»¥ä¸‹ç»´åº¦è¿›è¡Œä¸“ä¸šè¯„å®¡ï¼š

1. ðŸ“‹ **è§„èŒƒæ€§æ£€æŸ¥** (0-100åˆ†)
   - æ–‡æ¡£ç»“æž„æ˜¯å¦æ¸…æ™°
   - æ ¼å¼æ˜¯å¦è§„èŒƒ
   - å¿…è¦ä¿¡æ¯æ˜¯å¦å®Œæ•´

2. ðŸ” **æ¸…æ™°åº¦è¯„ä¼°** (0-100åˆ†)
   - éœ€æ±‚æè¿°æ˜¯å¦æ¸…æ™°
   - æ˜¯å¦å­˜åœ¨æ­§ä¹‰è¡¨è¿°
   - æœ¯è¯­ä½¿ç”¨æ˜¯å¦ä¸€è‡´

3. âœ… **å®Œæ•´æ€§éªŒè¯** (0-100åˆ†)
   - åŠŸèƒ½éœ€æ±‚æ˜¯å¦å®Œæ•´
   - éžåŠŸèƒ½éœ€æ±‚æ˜¯å¦è€ƒè™‘
   - å¼‚å¸¸åœºæ™¯æ˜¯å¦è¦†ç›–

4. ðŸ”— **ä¸€è‡´æ€§æ£€æŸ¥** (0-100åˆ†)
   - å†…éƒ¨é€»è¾‘æ˜¯å¦ä¸€è‡´
   - ä¸šåŠ¡è§„åˆ™æ˜¯å¦å†²çª
   - æ•°æ®å®šä¹‰æ˜¯å¦ç»Ÿä¸€

ã€è¾“å‡ºæ ¼å¼ã€‘
è¯·ä»¥JSONæ ¼å¼è¾“å‡ºè¯„å®¡ç»“æžœï¼š
```json
{{
  "overall_rating": "good",
  "completion_score": 85,
  "clarity_score": 78,
  "consistency_score": 82,
  "completeness_score": 88,
  "summary": "æ–‡æ¡£æ•´ä½“è´¨é‡è‰¯å¥½ï¼Œç»“æž„æ¸…æ™°...",
  "recommendations": "å»ºè®®å®Œå–„å¼‚å¸¸å¤„ç†åœºæ™¯...",
  "issues": [
    {{
      "title": "é—®é¢˜æ ‡é¢˜",
      "description": "é—®é¢˜æè¿°",
      "priority": "high",
      "category": "completeness",
      "location": "ç¬¬2ç« ç”¨æˆ·ç®¡ç†æ¨¡å—",
      "suggestion": "æ”¹è¿›å»ºè®®"
    }}
  ]
}}
```"""
            },
            'global_analysis': {
                'name': 'å…¨å±€åˆ†æž',
                'description': 'ç”¨äºŽåˆ†æžéœ€æ±‚æ–‡æ¡£å…¨å±€ç»“æž„å’Œä¸Šä¸‹æ–‡çš„æç¤ºè¯',
                'content': """ä½ æ˜¯ä¸€ä½èµ„æ·±çš„éœ€æ±‚åˆ†æžå¸ˆï¼Œæ­£åœ¨è¿›è¡Œéœ€æ±‚è¯„å®¡ã€‚è¯·å¯¹ä»¥ä¸‹éœ€æ±‚æ–‡æ¡£è¿›è¡Œå…¨å±€ç»“æž„åˆ†æžï¼š

ã€æ–‡æ¡£ä¿¡æ¯ã€‘
æ ‡é¢˜: {title}
æè¿°: {description}
å†…å®¹: {content}

ã€åˆ†æžè¦æ±‚ã€‘
è¯·ä»Žä»¥ä¸‹ç»´åº¦è¿›è¡Œå…¨å±€åˆ†æžï¼š

1. ðŸ“‹ **æ–‡æ¡£ç»“æž„è§„èŒƒæ€§**
   - æ–‡æ¡£ç»„ç»‡ç»“æž„æ˜¯å¦æ¸…æ™°
   - ç« èŠ‚ç¼–å·æ˜¯å¦è§„èŒƒ
   - æ ‡é¢˜å±‚çº§æ˜¯å¦åˆç†

2. ðŸŽ¯ **ä¸šåŠ¡å®Œæ•´æ€§**
   - ä¸šåŠ¡æµç¨‹æ˜¯å¦å®Œæ•´
   - æ ¸å¿ƒåŠŸèƒ½æ˜¯å¦é—æ¼
   - ä¸šåŠ¡è¾¹ç•Œæ˜¯å¦æ¸…æ™°

3. ðŸ”— **é€»è¾‘ä¸€è‡´æ€§**
   - æ•´ä½“é€»è¾‘æ˜¯å¦è‡ªæ´½
   - ä¸šåŠ¡è§„åˆ™æ˜¯å¦ä¸€è‡´
   - æ•°æ®æµæ˜¯å¦åˆç†

4. ðŸ“Š **è´¨é‡è¯„ä¼°**
   - éœ€æ±‚æè¿°çš„æ¸…æ™°åº¦
   - å¯å®žçŽ°æ€§è¯„ä¼°
   - é£Žé™©ç‚¹è¯†åˆ«

ã€è¾“å‡ºæ ¼å¼ã€‘
è¯·ä»¥JSONæ ¼å¼è¾“å‡ºåˆ†æžç»“æžœï¼š
```json
{{
  "structure_score": 85,
  "completeness_score": 78,
  "consistency_score": 90,
  "clarity_score": 82,
  "overall_score": 84,
  "business_flows": ["ç”¨æˆ·æ³¨å†Œæµç¨‹", "è®¢å•å¤„ç†æµç¨‹"],
  "data_entities": ["ç”¨æˆ·", "å•†å“", "è®¢å•"],
  "global_rules": ["æ‰€æœ‰æ“ä½œéœ€è¦ç™»å½•", "æ”¯ä»˜å¿…é¡»éªŒè¯"],
  "missing_aspects": ["å¼‚å¸¸å¤„ç†", "æ€§èƒ½è¦æ±‚"],
  "risk_points": ["æ”¯ä»˜å®‰å…¨", "æ•°æ®ä¸€è‡´æ€§"],
  "strengths": ["ä¸šåŠ¡æµç¨‹æ¸…æ™°", "åŠŸèƒ½åˆ’åˆ†åˆç†"],
  "weaknesses": ["ç¼ºå°‘éžåŠŸèƒ½éœ€æ±‚", "å¼‚å¸¸åœºæ™¯ä¸å®Œæ•´"]
}}
```"""
            },
            'module_analysis': {
                'name': 'æ¨¡å—åˆ†æž',
                'description': 'ç”¨äºŽåˆ†æžå•ä¸ªéœ€æ±‚æ¨¡å—çš„æç¤ºè¯',
                'content': """ä½ æ­£åœ¨è¯„å®¡éœ€æ±‚æ–‡æ¡£çš„ä¸€ä¸ªåŠŸèƒ½æ¨¡å—ã€‚è¯·è¿›è¡Œä¸“ä¸šçš„éœ€æ±‚è¯„å®¡åˆ†æžï¼š

ã€æ¨¡å—ä¿¡æ¯ã€‘
æ¨¡å—åç§°: {module_title}
æ¨¡å—å†…å®¹: {module_content}

ã€å…¨å±€ä¸Šä¸‹æ–‡ã€‘
ä¸šåŠ¡æµç¨‹: {business_flows}
æ•°æ®å®žä½“: {data_entities}
å…¨å±€è§„åˆ™: {global_rules}

ã€è¯„å®¡ç»´åº¦ã€‘
è¯·ä»Žä»¥ä¸‹ç»´åº¦è¿›è¡Œè¯¦ç»†åˆ†æžï¼š

1. ðŸ“‹ **è§„èŒƒæ€§æ£€æŸ¥**
   - éœ€æ±‚æè¿°æ˜¯å¦å®Œæ•´
   - æ ¼å¼æ˜¯å¦ç¬¦åˆæ ‡å‡†
   - å¿…è¦ä¿¡æ¯æ˜¯å¦ç¼ºå¤±

2. ðŸ” **æ¸…æ™°åº¦è¯„ä¼°**
   - è¡¨è¿°æ˜¯å¦æ¨¡ç³Šä¸æ¸…
   - æ˜¯å¦å­˜åœ¨æ­§ä¹‰
   - æœ¯è¯­ä½¿ç”¨æ˜¯å¦ä¸€è‡´

3. âœ… **å®Œæ•´æ€§éªŒè¯**
   - åŠŸèƒ½éœ€æ±‚æ˜¯å¦å®Œæ•´
   - å¼‚å¸¸åœºæ™¯æ˜¯å¦è€ƒè™‘
   - è¾¹ç•Œæ¡ä»¶æ˜¯å¦æ˜Žç¡®

4. ðŸ”— **ä¸€è‡´æ€§æ£€æŸ¥**
   - ä¸Žå…¨å±€è§„åˆ™æ˜¯å¦ä¸€è‡´
   - ä¸Žå…¶ä»–æ¨¡å—æ˜¯å¦å†²çª
   - æ•°æ®å®šä¹‰æ˜¯å¦ç»Ÿä¸€

5. âš ï¸ **å¯è¡Œæ€§è¯„ä¼°**
   - æŠ€æœ¯å®žçŽ°éš¾åº¦
   - ä¸šåŠ¡åˆç†æ€§
   - èµ„æºéœ€æ±‚è¯„ä¼°

ã€è¾“å‡ºæ ¼å¼ã€‘
è¯·ä»¥JSONæ ¼å¼è¾“å‡ºåˆ†æžç»“æžœï¼š
```json
{{
  "module_id": "{module_id}",
  "module_name": "{module_title}",
  "specification_score": 85,
  "clarity_score": 78,
  "completeness_score": 90,
  "consistency_score": 82,
  "feasibility_score": 88,
  "overall_score": 84,
  "issues": [
    {{
      "type": "clarity",
      "priority": "high",
      "title": "ç”¨æˆ·æƒé™å®šä¹‰æ¨¡ç³Š",
      "description": "æƒé™ç­‰çº§çš„å…·ä½“å®šä¹‰ä¸æ¸…æ™°",
      "location": "æƒé™ç®¡ç†éƒ¨åˆ†",
      "suggestion": "å»ºè®®æ˜Žç¡®å®šä¹‰å„æƒé™ç­‰çº§çš„å…·ä½“æƒé™èŒƒå›´"
    }}
  ],
  "strengths": ["åŠŸèƒ½æè¿°æ¸…æ™°", "ä¸šåŠ¡æµç¨‹åˆç†"],
  "weaknesses": ["ç¼ºå°‘å¼‚å¸¸å¤„ç†", "è¾¹ç•Œæ¡ä»¶ä¸æ˜Žç¡®"],
  "recommendations": ["è¡¥å……å¼‚å¸¸åœºæ™¯", "æ˜Žç¡®æ•°æ®æ ¼å¼"]
}}
```"""
            },
            'consistency_analysis': {
                'name': 'ä¸€è‡´æ€§åˆ†æž',
                'description': 'ç”¨äºŽåˆ†æžéœ€æ±‚æ–‡æ¡£è·¨æ¨¡å—ä¸€è‡´æ€§çš„æç¤ºè¯',
                'content': """ä½ æ­£åœ¨è¿›è¡Œéœ€æ±‚æ–‡æ¡£çš„è·¨æ¨¡å—ä¸€è‡´æ€§æ£€æŸ¥ã€‚è¯·åˆ†æžå„æ¨¡å—é—´çš„ä¸€è‡´æ€§é—®é¢˜ï¼š

ã€å…¨å±€ä¸Šä¸‹æ–‡ã€‘
{global_context}

ã€å„æ¨¡å—åˆ†æžç»“æžœã€‘
{module_analyses}

ã€ä¸€è‡´æ€§æ£€æŸ¥è¦æ±‚ã€‘
è¯·é‡ç‚¹æ£€æŸ¥ä»¥ä¸‹æ–¹é¢ï¼š

1. ðŸ”— **æŽ¥å£ä¸€è‡´æ€§**
   - æ¨¡å—é—´æŽ¥å£å®šä¹‰æ˜¯å¦ä¸€è‡´
   - æ•°æ®ä¼ é€’æ ¼å¼æ˜¯å¦ç»Ÿä¸€
   - è°ƒç”¨å…³ç³»æ˜¯å¦æ¸…æ™°

2. ðŸ“Š **æ•°æ®ä¸€è‡´æ€§**
   - æ•°æ®å®žä½“å®šä¹‰æ˜¯å¦ç»Ÿä¸€
   - çŠ¶æ€å®šä¹‰æ˜¯å¦ä¸€è‡´
   - æ•°æ®æµè½¬æ˜¯å¦åˆç†

3. ðŸ“‹ **ä¸šåŠ¡è§„åˆ™ä¸€è‡´æ€§**
   - ä¸šåŠ¡è§„åˆ™åœ¨å„æ¨¡å—ä¸­æ˜¯å¦ä¸€è‡´
   - æƒé™æŽ§åˆ¶æ˜¯å¦ç»Ÿä¸€
   - å¼‚å¸¸å¤„ç†æ˜¯å¦ä¸€è‡´

4. ðŸ”„ **æµç¨‹å®Œæ•´æ€§**
   - ä¸šåŠ¡æµç¨‹æ˜¯å¦é—­çŽ¯
   - æ˜¯å¦å­˜åœ¨æµç¨‹æ–­ç‚¹
   - å¼‚å¸¸æµç¨‹æ˜¯å¦å®Œæ•´

ã€è¾“å‡ºæ ¼å¼ã€‘
è¯·ä»¥JSONæ ¼å¼è¾“å‡ºåˆ†æžç»“æžœï¼š
```json
{{
  "consistency_score": 85,
  "interface_consistency": 78,
  "data_consistency": 90,
  "business_rule_consistency": 82,
  "process_completeness": 88,
  "cross_module_issues": [
    {{
      "type": "data_inconsistency",
      "priority": "high",
      "title": "ç”¨æˆ·çŠ¶æ€å®šä¹‰ä¸ä¸€è‡´",
      "description": "ç”¨æˆ·ç®¡ç†æ¨¡å—å’Œè®¢å•æ¨¡å—å¯¹ç”¨æˆ·çŠ¶æ€å®šä¹‰ä¸åŒ",
      "affected_modules": ["ç”¨æˆ·ç®¡ç†", "è®¢å•ç®¡ç†"],
      "suggestion": "ç»Ÿä¸€ç”¨æˆ·çŠ¶æ€å®šä¹‰ï¼Œå»ºç«‹æ•°æ®å­—å…¸"
    }}
  ],
  "missing_connections": ["æ”¯ä»˜æ¨¡å—ä¸Žåº“å­˜æ¨¡å—ç¼ºå°‘è¿žæŽ¥"],
  "redundant_functions": ["ç”¨æˆ·éªŒè¯åŠŸèƒ½åœ¨å¤šä¸ªæ¨¡å—é‡å¤"],
  "recommendations": ["å»ºç«‹ç»Ÿä¸€çš„æ•°æ®å­—å…¸", "æ˜Žç¡®æ¨¡å—é—´æŽ¥å£è§„èŒƒ"]
}}
```"""
            }
        }

        created_prompts = []
        skipped_prompts = []

        # éåŽ†æ‰€æœ‰æç¤ºè¯ç±»åž‹ï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æœ‰ï¼Œæ²¡æœ‰åˆ™åˆ›å»º
        for prompt_type, prompt_data in default_prompts.items():
            existing_prompt = UserPrompt.objects.filter(
                user=request.user,
                prompt_type=prompt_type
            ).first()

            if existing_prompt:
                # å·²å­˜åœ¨ï¼Œè·³è¿‡
                skipped_prompts.append({
                    'type': prompt_type,
                    'name': prompt_data['name'],
                    'reason': 'å·²å­˜åœ¨'
                })
            else:
                # åˆ›å»ºæ–°æç¤ºè¯
                new_prompt = UserPrompt.objects.create(
                    user=request.user,
                    name=prompt_data['name'],
                    description=prompt_data['description'],
                    content=prompt_data['content'],
                    prompt_type=prompt_type,
                    is_default=False,  # ç¨‹åºè°ƒç”¨ç±»åž‹ä¸èƒ½è®¾ä¸ºé»˜è®¤
                    is_active=True
                )
                serializer = self.get_serializer(new_prompt)
                created_prompts.append(serializer.data)

        return Response({
            "status": "success",
            "code": status.HTTP_200_OK,
            "message": f"åˆå§‹åŒ–å®Œæˆï¼åˆ›å»ºäº† {len(created_prompts)} ä¸ªæç¤ºè¯ï¼Œè·³è¿‡ {len(skipped_prompts)} ä¸ª",
            "data": {
                "created": created_prompts,
                "skipped": skipped_prompts,
                "summary": {
                    "created_count": len(created_prompts),
                    "skipped_count": len(skipped_prompts),
                    "total_types": len(default_prompts)
                }
            },
            "errors": {}
        })

    @action(detail=False, methods=['get'])
    def init_status(self, request):
        """èŽ·å–ç”¨æˆ·æç¤ºè¯åˆå§‹åŒ–çŠ¶æ€"""
        # èŽ·å–ç”¨æˆ·çŽ°æœ‰çš„æç¤ºè¯ç±»åž‹
        existing_types = set(UserPrompt.objects.filter(
            user=request.user
        ).values_list('prompt_type', flat=True))

        # æ‰€æœ‰å¯ç”¨çš„æç¤ºè¯ç±»åž‹
        all_types = dict(UserPrompt.PROMPT_TYPE_CHOICES)
        
        status_info = []
        for prompt_type, display_name in all_types.items():
            status_info.append({
                'type': prompt_type,
                'name': display_name,
                'exists': prompt_type in existing_types,
                'is_program_call': prompt_type in UserPrompt.PROGRAM_CALL_TYPES
            })

        missing_types = [
            info for info in status_info 
            if not info['exists']
        ]

        return Response({
            "status": "success",
            "code": status.HTTP_200_OK,
            "message": "èŽ·å–åˆå§‹åŒ–çŠ¶æ€æˆåŠŸ",
            "data": {
                "all_types": status_info,
                "missing_types": missing_types,
                "summary": {
                    "total_types": len(all_types),
                    "existing_count": len(existing_types),
                    "missing_count": len(missing_types),
                    "can_initialize": len(missing_types) > 0
                }
            },
            "errors": {}
        })
